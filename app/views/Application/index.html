#{extends 'main.html' /} #{set title:'Play Project Web Demo' /}

<style type="text/css">
/* Accordion
----------------------------------*/
div#available-topics-container {
	border: 1px solid #DDDDDD;
	border-radius: 2px;
	diplay: block;
	height: 500px;
	width: 270px;
	overflow-y: scroll;
	overflow-x: hidden;
	float: left;
	padding: 3px;
}

div#available-topics {
	font-size: 95%;
	float: left;
	width: 250px;
}

div#available-topics div {
	font-size: 110%;
}

/* Vertical Tabs
----------------------------------*/
div#topics {
	font-size: 80%;
	float: left;
	padding: 0 0 0 20px;
	height: 500px;
	width: 480px;
}

.ui-tabs-vertical {
	width: 660px;
}

.ui-tabs-vertical .ui-tabs-nav {
	padding: 3px 2px 3px 3px;
	float: left;
	width: 210px;
}

.ui-tabs-vertical .ui-tabs-nav li {
	clear: left;
	width: 100%;
	border-bottom-width: 1px !important;
	border-right-width: 0 !important;
	margin: 0 -1px 3px 0;
}

.ui-tabs-vertical .ui-tabs-nav li a {
	display: block;
	width: 90%;
}

.ui-tabs-vertical .ui-tabs-nav li.ui-tabs-selected {
	padding-bottom: 0;
	margin-bottom: 2px;
	padding-right: 2px;
	border-right-width: 1px;
	border-right-width: 1px;
}

.ui-tabs-vertical .ui-tabs-panel {
	overflow-y: scroll;
	overflow-x: hidden;
	padding: 0 16px 16px 16px;
	float: right;
	width: 410px;
	min-height: 486px;
}

.event {
	margin-top: 10px;
}

.event h3 {
	font-size: 12px;
	margin-bottom: 5px;
}


a.subscribe-button {
	position: absolute;
	margin-top: -27px;
	margin-left: 190px;
}

a.subscribe-button:hover {
	color: #EE0;
}

a.unsubscribe-button {
 	display: block;
    font-size: 70%;
    font-weight: bold;
    margin-left: 300px;
    margin-right: 10px;
    margin-top: -18px;
    position: absolute;
    text-decoration: none;
}

a.unsubscribe-button:hover {
	color: #EE0;
}

.unread-count {
	float: right;
	width: 100px;
	text-align: right;
}

/* Dialog panel */
div.ui-dialog {
	font-size: 1em;
}
</style>


#{if fbInfo != null && fbInfo.get("error") == null}
<h1>
	Hello <a href='${fbInfo.get("link").getAsString()}'><img
		src="http://graph.facebook.com/${fbInfo.get("username").getAsString()}/picture" />${fbInfo.get("name").getAsString()}</a>
</h1>
#{/if} #{else}
<h1 class="pagetitle">Hello ${u.firstname+" "+u.lastname} !</h1>
#{/else}
<br />

<div id="available-topics-container">
	<div id="topic-search-bar" style="margin: 5px 0px 0px 5px">
		<input name="search"
			style="width: 80%; float: left;" /> <img
			src="@{'/public/images/search_ico.png'}"
			style="height: 23px; float: left; margin-left: 5px;" /><br /> <br />
	</div>
	<div id="available-topics">
		<h3 id="topic-5000">
			<a href="#">Error Topic</a><a href="#" class="subscribe-button">Sub</a>
		</h3>
		<div id="desc-topic-5000">
			<p>A topic to generate errors</p>
		</div>
		%{ for(int i=0; i < topics.size(); i++){
		}%
		<h3 id="topic-${topics.get(i).getId()}">
			<a href="#">${topics.get(i).getId()}</a><a href="#"
				class="subscribe-button">Sub</a>
		</h3>
		<div id="desc-topic-${topics.get(i).getId()}"><p>
			Title : ${topics.get(i).title}<br/>
			Content : ${topics.get(i).content}
		</p></div>
		%{	
			}
		%}
	</div>
</div>

<div id="topics">
	<div id="tabs">
		<ul id="topic-tabs">
			<li><a href="#tab-alltopics"><span id="unread-all"
					class="unread-count">0</span>All topics</a>
			</li> 
			%{ for(int i=0; i < userTopics.size(); i++){
			}%
			<li><a href="#tab-topic-${userTopics.get(i).getId()}"><span
					id="unread-${userTopics.get(i).getId()}" class="unread-count">0</span>${userTopics.get(i).getId()}</a>
			</li>
			%{
				}
			}%
		</ul>
		<div id="tab-alltopics">
			<h2>All topics</h2>
			<div id="alltopics-events"></div>
		</div>
		%{ for(int i=0; i<userTopics.size(); i++){
		}%

		<div id="tab-topic-${userTopics.get(i).getId()}">
			<h2>
				${userTopics.get(i).getId()}<a href="#"
					id="unsubscribe-button-${userTopics.get(i).getId()}"
					class="unsubscribe-button">Unsubscribe</a>
			</h2>
			<div id="topic-events-${userTopics.get(i).getId()}"></div>
		</div>
		%{
			}
		}%
	</div>

	<div id="error1" title="Error">
		<br /> <span class="ui-icon ui-icon-alert"
			style="float: left; margin: -2px 30px 0 15px;"></span>Error : topic
		not found
	</div>
	<div id="error2" title="Error">
		<br /> <span class="ui-icon ui-icon-alert"
			style="float: left; margin: -2px 30px 0 15px;"></span>Error :
		subscription failed
	</div>
	<div id="error3" title="Error">
		<br /> <span class="ui-icon ui-icon-alert"
			style="float: left; margin: -2px 30px 0 15px;"></span>Error :
		unsubscription failed
	</div>
	<div id="error4" title="Error">
		<br /> <span class="ui-icon ui-icon-alert"
			style="float: left; margin: -2px 30px 0 15px;"></span>Error :
		disconnected
	</div>
</div>

<div style="clear: left; padding-top: 30px;">
	<input id="send0" type="button" value="Send event on internalns_rootTopic1" /><br />
	<input id="send1" type="button" value="Send event on internalns_childTopic1" /><br />
	<input id="send2" type="button" value="Send event on internalns_grandChildTopic21" /><br />
	<input id="send3" type="button" value="Send event on internalns_childTopic3" /><br />
</div>

<script type="text/javascript">
$(function() {
	$("#available-topics").accordion({
			autoHeight: false,
			navigation: true,
			collapsible: true
	});
	/*
	$("#available-topics").sortable({
            delay: 300,
            opacity: 0.7,
            revert: 100,
            scroll: true,
            helper: 'original',
            zIndex: 50000
    });
	*/
    $("#topic-tabs").sortable({
            distance: 10,
            opacity: 0.7,
            revert: 100,
            scroll: true,
            helper: 'clone',
            zIndex: 50000
	});
	$("#tabs").tabs().addClass('ui-tabs-vertical ui-helper-clearfix');
	$("#tabs li").removeClass('ui-corner-top').addClass('ui-corner-left');
	$(".ui-tabs-vertical .ui-tabs-panel").height($(".ui-tabs-nav").first().height());
	
	$("#error1, #error2, #error3").dialog({
		resizable: false,
		draggable: false,
		autoOpen: false,
		modal: true,
		height: 120,
		buttons: {
			Ok: function() {
				$(this).dialog("close");
			}
		}
	});
	$("#error4").dialog({
		resizable: false,
		draggable: false,
		autoOpen: false,
		modal: true,
		height: 120,
		buttons: {
			Ok: function() {
				location.href = "/";
			}
		}
	});
	
	var subAction = #{jsAction @subscribe(':topicId') /}
	$("a.subscribe-button").live('click', function() {
		var $id = $(this).parent().attr('id');
		var $sid = $id.substring($id.lastIndexOf('-') + 1);
	    $.ajax({
            url: subAction({topicId: $sid}),
            type: 'POST',
	        dataType: 'json',
	        success: function(results) {
	            $(results).each(function() {
		            if(this.id != "-1"){
						$("#available-topics").accordion("destroy");
						$('#topic-'+this.id+'').remove();
						$('#desc-topic-'+this.id+'').remove();
						$("#available-topics").accordion({
							autoHeight: false,
							navigation: true,
							collapsible: true
						});
						$('#tabs').tabs('add','#tab-topic-'+this.id+'','<span id="unread-'+this.id+'" class="unread-count">0</span>'+this.id);
						$('#tab-topic-'+this.id).html('<h2>'+this.id+'<a href="#" id="unsubscribe-button-'+this.id+'" class="unsubscribe-button">Unsubscribe</a></h2><div id="topic-events-'+this.id+'"></div>');
					} else {
						$("#error2").dialog("open");
					}
				})
	        },
	        error: function() {
				$("#error1").dialog("open");
				$("#available-topics").accordion( "option", "disabled", false );
	        }
	    });
	});
	
	var unsubAction = #{jsAction @unsubscribe(':topicId') /}
	$("a.unsubscribe-button").live('click', function() {
		var $id = $(this).attr('id');
		var $sid = $id.substring($id.lastIndexOf('-') + 1);
	    $.ajax({
            url: unsubAction({topicId: $sid}),
            type: 'POST',
	        dataType: 'json',
	        success: function(results) {
	            $(results).each(function() {
		            if(this.id != "-1"){
						$("#available-topics")
							.accordion("destroy")
							.append('<h3 id="topic-'+this.id+'"><a href="#">'+this.id+'</a><a href="#" class="subscribe-button">Sub</a></h3><div id="desc-topic-'+this.id+'"><p>Title: '+this.title+'<br/>Content: '+this.content+'</p></div>')
							.accordion({
									autoHeight: false,
									navigation: true,
									collapsible: true
							});
						$("#tabs").tabs("remove", $("#tabs").tabs("option", "selected"));
					} else {
						$("#error1").dialog("open");
					}
				})
	        },
	        error: function() {
				$("#error3").dialog("open");
	        }
	    });
	});
});

var $lastReceived = 0
var waitEvents = #{jsAction @waitEvents(':lastReceived') /}
%{
	String txt = "Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus ullamcorper laoreet fermentum. Cras placerat dui pharetra arcu ultricies sit amet commodo tortor molestie.";
}%
var send0 = #{jsAction @sendEvent('Event !', txt, 'internalns_rootTopic1') /}
var send1 = #{jsAction @sendEvent('Event !', txt, 'internalns_childTopic1') /}
var send2 = #{jsAction @sendEvent('Event !', txt, 'internalns_grandChildTopic21') /}
var send3 = #{jsAction @sendEvent('Event !', txt, 'internalns:childTopic3') /}

$("#send0").click(function(e) {
	$.post(send0())
});
$("#send1").click(function(e) {
	$.post(send1())
});
$("#send2").click(function(e) {
	$.post(send2())
});
$("#send3").click(function(e) {
	$.post(send3())
});

var getEvents = function() {
	$.ajax({
		url: waitEvents({lastReceived: $lastReceived}),
		type: 'GET',
		dataType: 'json',
		success: function(events) {
			if(events.error == "disconnected"){
				$("#error4").dialog("open")
			}
			var k = events.length;
			$(events).each(function() {
				k--;
				display(this, (k == 0));
				$lastReceived = this.id;
			})
			getEvents()
		},
		error: function() {
			getEvents();
		}
	});
}

var display = function(event, blink) {
	if(blink){
		$('#unread-'+event.data.topicId).parent().animate({
			"color": "#FF0"
		}, 200);
	}
	
	var cptall = parseInt($('#unread-all').html());
	$('#unread-all').html(cptall+1);
	var cpt = parseInt($('#unread-'+event.data.topicId).html());
	$('#unread-'+event.data.topicId).html(cpt+1);
	
	if(blink){
		$('#unread-'+event.data.topicId).parent().animate({
			"color": "#4F7425"
		}, 200);
	}
	
	$('#topic-events-'+event.data.topicId)
		.prepend('<div id="event-'+event.id+'" class="event"><h3>'+event.id+' : '+event.data.title+'</h3><p>'+event.data.content+'</p></div>');
	$('#event-'+event.id).hide().fadeIn();
	
	$('#alltopics-events')
		.prepend('<div id="eventall-'+event.id+'" class="event"><h3>'+event.id+' : '+event.data.title+'</h3><p>'+event.data.content+'</p></div>');
	$('#eventall-'+event.id).hide().fadeIn();
}

$(document).ready(function(){
	getEvents();
});
</script>